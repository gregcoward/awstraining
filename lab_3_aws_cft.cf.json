{
  "AWSTemplateFormatVersion" : "2010-09-09",
 
  "Description" : "This template creates a full deployment of a VPC and all supporting infrastructure as well as a single server of Microsoft Windows Server 2012 R2, and then finally configures IIS.",

  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "Basics"
          },
          "Parameters": [
            "Name",
            "KeyName",
            "adminUsername",
            "adminPassword"
          ]
        },
        {
          "Label": {
            "default": "Size"
          },
          "Parameters": [
            "InstanceType"
          ]
        },
        {
          "Label": {
            "default": "Settings"
          },
          "Parameters": [
            "VPCId",
            "SubnetId",
            "BIGIPAMI"
          ]
        }
      ],
      "ParameterLabels": {}
    }
  },
     
  "Parameters": {
    "KeyName": {
      "Description": "Name of an existing EC2 KeyPair",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "ConstraintDescription": "Must be the name of an existing EC2 KeyPair."
    },
    "Name": {
      "Description": "The name of the BIG-IP.",
      "Type": "String"
    },
    "adminUsername": {
      "Type": "String",
      "Description": "An admin username for loging into the BIG-IP.",
      "MaxLength": "255",
      "MinLength": "1"
    },
    "adminPassword": {
      "Type": "String",
      "NoEcho": "true",
      "Description": "A password that will be used to login to the BIG-IP.",
      "MaxLength": "255",
      "MinLength": "1"
    },
    "InstanceType": {
      "Description": "EC2 instance type",
      "Type": "String",
      "Default": "m3.xlarge",
      "AllowedValues": [
        "m3.xlarge",
        "m3.2xlarge",
        "c1.medium",
        "c1.xlarge",
        "cc1.4xlarge",
        "cc2.8xlarge",
        "cg1.4xlarge"
      ],
      "ConstraintDescription": "Choose one of these."
    },
    "VPCId": {
      "Description": "Select an existing VPC.",
      "Type": "AWS::EC2::VPC::Id",
      "ConstraintDescription": "Must be an already existing VPC."
    },
    "SubnetId": {
      "Description": "Select an existing Subnet in the above VPC.",
      "Type": "AWS::EC2::Subnet::Id",
      "ConstraintDescription": "Must an already existing Subnet with an already existing VPC."
    },
    "BIGIPAMI": {
      "Description": "F5 BIG-IP AMI to install from.",
      "Type": "String",
      "Default": "ami-0b7a011c"
    }
  },
   
  "Resources" : {

    "BIGIPSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "Enable HTTP and RDP",
        "VpcId" : { "Ref" : "VPCId" },
        "SecurityGroupIngress" : [
          {"IpProtocol" : "tcp", "FromPort" : "80", "ToPort" : "80", "CidrIp" : "0.0.0.0/0"},
          {"IpProtocol" : "tcp", "FromPort" : "8443", "ToPort" : "8443", "CidrIp" : "0.0.0.0/0"},
          {"IpProtocol" : "tcp", "FromPort" : "443", "ToPort" : "443", "CidrIp" : "0.0.0.0/0"},
          {"IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp" : "0.0.0.0/0"}
        ]
      }
    },

    "BIGIPInstance": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "InstanceType"   : { "Ref" : "InstanceType" },
        "ImageId": { "Ref" : "BIGIPAMI" },
        "KeyName" : { "Ref" : "KeyName" },
        "SubnetId" : { "Ref" : "SubnetId"},
        "SecurityGroupIds" : [ {"Fn::GetAtt" : [ "BIGIPSecurityGroup", "GroupId" ]} ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash\n",
                "/opt/aws/apitools/cfn-init-1.4-0.amzn1/bin/cfn-init -v -s ",
                {
                  "Ref": "AWS::StackId"
                },
                " -r ",
                "BIGIPInstance",
                " --region ",
                {
                  "Ref": "AWS::Region"
                },
                "\n"
              ]
            ]
          }
        }        
      }
    }
  },
  
  "Outputs" : {
    "ServerURL" : {
      "Description": "The BIG-IP MGMT URL.",
      "Value" : { "Fn::Join" : [ "", [
        "https://",
        {"Fn::GetAtt": [ "BIGIPInstance", "PublicDnsName" ]},
        ":8443/"
        ]]}
    }
  }  
}