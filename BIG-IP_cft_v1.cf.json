{
  "AWSTemplateFormatVersion" : "2010-09-09",
 
  "Description" : "This template creates a full deployment of a VPC and all supporting infrastructure as well as a single server of Microsoft Windows Server 2012 R2, and then finally configures IIS.",

  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "Basics"
          },
          "Parameters": [
            "Name",
            "KeyName",
            "adminUsername",
            "adminPassword"
          ]
        },
        {
          "Label": {
            "default": "Size"
          },
          "Parameters": [
            "InstanceType"
          ]
        },
        {
          "Label": {
            "default": "Settings"
          },
          "Parameters": [
            "VPCId",
            "SubnetId",
            "BIGIPAMI"
          ]
        }
      ],
      "ParameterLabels": {}
    }
  },
     
  "Parameters": {
    "KeyName": {
      "Description": "Name of an existing EC2 KeyPair",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "ConstraintDescription": "Must be the name of an existing EC2 KeyPair."
    },
    "Name": {
      "Description": "The name of the BIG-IP.",
      "Type": "String"
    },
    "adminUsername": {
      "Type": "String",
      "Description": "An admin username for loging into the BIG-IP.",
      "MaxLength": "255",
      "MinLength": "1"
    },
    "adminPassword": {
      "Type": "String",
      "NoEcho": "true",
      "Description": "A password that will be used to login to the BIG-IP.",
      "MaxLength": "255",
      "MinLength": "1"
    },
    "InstanceType": {
      "Description": "EC2 instance type",
      "Type": "String",
      "Default": "m3.xlarge",
      "AllowedValues": [
        "m3.xlarge",
        "m3.2xlarge",
        "c1.medium",
        "c1.xlarge",
        "cc1.4xlarge",
        "cc2.8xlarge",
        "cg1.4xlarge"
      ],
      "ConstraintDescription": "Choose one of these."
    },
    "VPCId": {
      "Description": "Select an existing VPC.",
      "Type": "AWS::EC2::VPC::Id",
      "ConstraintDescription": "Must be an already existing VPC."
    },
    "SubnetId": {
      "Description": "Select an existing Subnet in the above VPC.",
      "Type": "AWS::EC2::Subnet::Id",
      "ConstraintDescription": "Must an already existing Subnet with an already existing VPC."
    },
    "BIGIPAMI": {
      "Description": "F5 BIG-IP AMI to install from.",
      "Type": "String",
      "Default": "ami-0b7a011c"
    }
  },
   
  "Resources" : {

    "BIGIPSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "Enable HTTP and RDP",
        "VpcId" : { "Ref" : "VPCId" },
        "SecurityGroupIngress" : [
          {"IpProtocol" : "tcp", "FromPort" : "80", "ToPort" : "80", "CidrIp" : "0.0.0.0/0"},
          {"IpProtocol" : "tcp", "FromPort" : "8443", "ToPort" : "8443", "CidrIp" : "0.0.0.0/0"},
          {"IpProtocol" : "tcp", "FromPort" : "443", "ToPort" : "443", "CidrIp" : "0.0.0.0/0"},
          {"IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp" : "0.0.0.0/0"}
        ]
      }
    },

    "BIGIPInstance": {
      "Type": "AWS::EC2::Instance",
      "Metadata": {
        "AWS::CloudFormation::Init": {
          "config": {
            "files": {
              "/config/cloud/aws/firstrun.utils": {
                "group": "root",
                "mode": "000755",
                "owner": "root",
                "source": "http://cdn.f5.com/product/templates/utils/firstrun.utils"
              },
              "/config/cloud/f5-cloud-libs.tar.gz": {
                "group": "root",
                "mode": "000755",
                "owner": "root",
                "source": "https://raw.githubusercontent.com/F5Networks/f5-cloud-libs/v2.0.1/dist/f5-cloud-libs.tar.gz"
              },
              "/config/cloud/aws/getNameServer.sh": {
                "content": {
                  "Fn::Join": [
                    "\n",
                    [
                      "INTERFACE=$1",
                      "INTERFACE_MAC=`ifconfig ${INTERFACE} | egrep HWaddr | awk '{print tolower($5)}'`",
                      "INTERFACE_MAC=`ifconfig ${INTERFACE} | egrep HWaddr | awk '{print tolower($5)}'`",
                      "VPC_CIDR_BLOCK=`curl -s http://169.254.169.254/latest/meta-data/network/interfaces/macs/${INTERFACE_MAC}/vpc-ipv4-cidr-block`",
                      "VPC_NET=${VPC_CIDR_BLOCK%/*}",
                      "NAME_SERVER=`echo ${VPC_NET} | awk -F. '{ printf \"%d.%d.%d.%d\", $1, $2, $3, $4+2 }'`",
                      "echo $NAME_SERVER"
                    ]
                  ]
                },
                "mode": "000755",
                "owner": "root",
                "group": "root"
              }
            },
            "commands": {
              "001-unpack-libs": {
                "command": {
                  "Fn::Join": [
                    " ",
                    [
                      "tar xvzf /config/cloud/f5-cloud-libs.tar.gz -C /config/cloud/aws/;",
                      "mv /config/cloud/aws/F5Networks-f5-cloud-libs-* /config/cloud/aws/f5-cloud-libs;",
                      "cd /config/cloud/aws/f5-cloud-libs;",
                      "npm install --production;"
                    ]
                  ]
                }
              },
              "003-onboard-BIG-IP": {
                "command": {
                  "Fn::Join": [
                    " ",
                    [
                      "NAME_SERVER=$( /config/cloud/aws/getNameServer.sh eth0 );",
                      "f5-rest-node /config/cloud/aws/f5-cloud-libs/scripts/onboard.js",
                      "--ssl-port '8443'",
                      "--log-level verbose",
                      "-o  /var/log/onboard.log",
                      "--no-reboot",
                      "--host localhost",
                      "--user admin ",
                      "--password '",
                      {
                        "Ref": "adminPassword"
                      },
                      "'",
                      "--update-user 'user:",
                      {
                        "Ref": "adminUsername"
                      },
                      ",password:",
                      {
                        "Ref": "adminPassword"
                      },
                      ",role:admin'",
                      "--hostname `curl http://169.254.169.254/latest/meta-data/hostname`",
                      "--ntp 0.us.pool.ntp.org",
                      "--ntp 1.us.pool.ntp.org",
                      "--tz UTC",
                      "--dns ${NAME_SERVER}",
                      "--module ltm:nominal"
                    ]
                  ]
                }
              }
            }
          }
        }
      },
      "Properties": {
        "InstanceType"   : { "Ref" : "InstanceType" },
        "ImageId": { "Ref" : "BIGIPAMI" },
        "KeyName" : { "Ref" : "KeyName" },
        "SubnetId" : { "Ref" : "SubnetId"},
        "SecurityGroupIds" : [ {"Fn::GetAtt" : [ "BIGIPSecurityGroup", "GroupId" ]} ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "<script>\n",

                "#!/bin/bash\n",
                "/opt/aws/apitools/cfn-init-1.4-0.amzn1/bin/cfn-init -v -s ",
                {
                  "Ref": "AWS::StackId"
                },
                " -r ",
                "BIGIPInstance",
                " --region ",
                {
                  "Ref": "AWS::Region"
                },
                "\n",
                "cfn-signal.exe -e $? ", 
                {
                    "Ref" : "BIGIPInstanceWaitHandle"
                }, 
                "\n",

                "</script>"
              ]
            ]
          }
        }        
      }
    },

    "BIGIPInstanceWaitHandle" : {
      "Type" : "AWS::CloudFormation::WaitConditionHandle"
    },

    "BIGIPInstanceWaitCondition" : {
      "Type" : "AWS::CloudFormation::WaitCondition",
      "DependsOn" : "BIGIPInstance",
      "Properties" : {
        "Handle" : {"Ref" : "BIGIPInstanceWaitHandle"},
        "Timeout" : "900"
      }
    }
  },
  
  "Outputs" : {
    "ServerURL" : {
      "Description": "The BIG-IP MGMT URL.",
      "Value" : { "Fn::Join" : [ "", [
        "https://",
        {"Fn::GetAtt": [ "BIGIPInstance", "PublicDnsName" ]},
        ":8443/"
        ]]}
    }
  }  
}